


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Traffic Ops - Migrating from 2.0 to 2.2 &mdash; Traffic Control 3.1.0 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Traffic Ops - Configuring" href="configuration.html" />
    <link rel="prev" title="Traffic Ops - Migrating from 1.x to 2.x" href="migration_from_10_to_20.html" />
    <link href="../../_static/theme_overrides.css" rel="stylesheet" type="text/css"/>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> Traffic Control
          

          
            
            <img src="../../_static/ATC-SVG-FULL-WHITE.svg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../basics/index.html">CDN Basics</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../overview/index.html">Traffic Control Overview</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Administrator’s Guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="installation.html">Traffic Ops - Installing</a></li>
<li class="toctree-l2"><a class="reference internal" href="migration_from_10_to_20.html">Traffic Ops - Migrating from 1.x to 2.x</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Traffic Ops - Migrating from 2.0 to 2.2</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#per-deliveryservice-routing-names">Per-DeliveryService Routing Names</a></li>
<li class="toctree-l3"><a class="reference internal" href="#apache-traffic-server-7-x-cachekey-plugin">Apache Traffic Server 7.x (Cachekey Plugin)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#examples-of-cacheurl-to-cachekey-replacements">Examples of Cacheurl to Cachekey Replacements</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#static-prefix-example">Static Prefix Example</a></li>
<li class="toctree-l4"><a class="reference internal" href="#removing-query-parameters-and-path-information">Removing Query Parameters and Path Information</a></li>
<li class="toctree-l4"><a class="reference internal" href="#removing-query-parameters-with-a-static-prefix">Removing Query Parameters with a Static Prefix</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#apache-traffic-server-7-x-logging">Apache Traffic Server 7.x (Logging)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#traffic-ops-profile-modifications">Traffic Ops Profile Modifications</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#usage-example">Usage Example</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html">Traffic Ops - Configuring</a></li>
<li class="toctree-l2"><a class="reference internal" href="using.html">Traffic Ops - Using</a></li>
<li class="toctree-l2"><a class="reference internal" href="extensions.html">Managing Traffic Ops Extensions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../traffic_portal/installation.html">Traffic Portal Administration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../traffic_portal/usingtrafficportal.html">Traffic Portal - Using</a></li>
<li class="toctree-l2"><a class="reference internal" href="../traffic_portal/default_profiles.html">Default Profiles</a></li>
<li class="toctree-l2"><a class="reference internal" href="../traffic_monitor.html">Traffic Monitor Administration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../traffic_router.html">Traffic Router Administration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../traffic_router/migrationto2-3.html">Traffic Router - Migrating to 3.0</a></li>
<li class="toctree-l2"><a class="reference internal" href="../traffic_stats.html">Traffic Stats Administration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../traffic_server.html">Traffic Server Administration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../traffic_vault.html">Traffic Vault Administration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quick_howto/index.html">Quick How To Guides</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../development/index.html">Developer’s Guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api/index.html">APIs</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../faq/index.html">FAQ</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../glossary.html">Glossary</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Traffic Control</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Administrator’s Guide</a> &raquo;</li>
        
      <li>Traffic Ops - Migrating from 2.0 to 2.2</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/admin/traffic_ops/migration_from_20_to_22.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="traffic-ops-migrating-from-2-0-to-2-2">
<h1>Traffic Ops - Migrating from 2.0 to 2.2<a class="headerlink" href="#traffic-ops-migrating-from-2-0-to-2-2" title="Permalink to this headline">¶</a></h1>
<div class="section" id="per-deliveryservice-routing-names">
<h2>Per-DeliveryService Routing Names<a class="headerlink" href="#per-deliveryservice-routing-names" title="Permalink to this headline">¶</a></h2>
<p>Before this release, DNS Delivery Services were hard-coded to use the name <code class="docutils literal notranslate"><span class="pre">edge</span></code>, so that URLs would appear as e.g. <code class="docutils literal notranslate"><span class="pre">edge.myds.mycdn.com</span></code>, and HTTP Delivery Services use the name <code class="docutils literal notranslate"><span class="pre">tr</span></code> <a class="footnote-reference brackets" href="#id2" id="id1">1</a>, e.g. <code class="docutils literal notranslate"><span class="pre">tr.myds.mycdn.com</span></code>. As of Traffic Control version 2.2, DNS routing names will default to <code class="docutils literal notranslate"><span class="pre">cdn</span></code> if left unspecified and can be set to any valid hostname, provided it does not contain the <code class="docutils literal notranslate"><span class="pre">.</span></code> character.</p>
<p>Prior to Traffic Control 2.2, the HTTP routing name was configurable via the <code class="docutils literal notranslate"><span class="pre">http.routing.name</span></code> option in in the Traffic Router <code class="docutils literal notranslate"><span class="pre">http.properties</span></code> configuration file. If your CDN uses that option to change the name from <code class="docutils literal notranslate"><span class="pre">tr</span></code> to something else, then you will need to perform the following steps for each CDN affected:</p>
<ol class="arabic">
<li><p>In Traffic Portal (if possible, else use the legacy Traffic Ops UI), create the following profile parameter (‘Configure’ -&gt; ‘Parameters’ -&gt; ‘+’). Be sure to double-check for typos, trailing spaces, etc.</p>
<blockquote>
<div><dl class="field-list simple">
<dt class="field-odd">name</dt>
<dd class="field-odd"><p>upgrade_http_routing_name</p>
</dd>
<dt class="field-even">config_file</dt>
<dd class="field-even"><p>temp</p>
</dd>
<dt class="field-odd">value</dt>
<dd class="field-odd"><p>Whatever value is used for the affected CDN’s <code class="docutils literal notranslate"><span class="pre">http.routing.name</span></code></p>
</dd>
</dl>
</div></blockquote>
</li>
<li><p>Add this parameter to a single profile in the affected CDN</p></li>
</ol>
<p>With those profile parameters in place, Traffic Ops can be safely upgraded to 2.2. Before taking a post-upgrade snapshot, make sure to check your Delivery Service example URLs for unexpected routing name changes. Once Traffic Ops has been upgraded to 2.2 and a post-upgrade snapshot has been taken, your Traffic Routers can be upgraded to 2.2 (Traffic Routers must be upgraded after Traffic Ops so that they can work with custom per-Delivery Service routing names).</p>
</div>
<div class="section" id="apache-traffic-server-7-x-cachekey-plugin">
<h2>Apache Traffic Server 7.x (Cachekey Plugin)<a class="headerlink" href="#apache-traffic-server-7-x-cachekey-plugin" title="Permalink to this headline">¶</a></h2>
<p>In Traffic Ops 2.2 we have added support for Apache Traffic Server (ATS) 7.x. With 7.x comes support for the new Cachekey Plugin which replaces the now-deprecated Cacheurl Plugin.
While not needed immediately it is recommended to start replacing Cacheurl usages with Cachekey as soon as possible, because ATS 6.x already supports the new Cachekey Plugin.</p>
<p>It is also recommended to thoroughly vet your Cachekey replacement by comparing with an existing key value. There are inconsistencies in the 6.x version of Cachekey which have been
fixed in 7.x (or require this patch(<a class="reference external" href="https://github.com/apache/trafficserver/commit/244288fab01bdad823f9de19dcece62a7e2a0c11">cachekeypatch</a>) on 6.x to match 7.x). So to ensure you have a matching key value you should use the XDebug Plugin before fully implementing your Cachekey replacement.</p>
<p>First, if you are currently using a regular expression for your Delivery Service you will have to remove that existing value. Then you will need to make a new Delivery Service profile and assign parameters to it that use the <code class="docutils literal notranslate"><span class="pre">cachekey.config</span></code> file.</p>
<p>Some common parameters are</p>
<dl class="simple">
<dt>static-prefix</dt><dd><p>This is used for a simple domain replacement.</p>
</dd>
<dt>separator</dt><dd><p>Used by Cachekey and in general is always a single space.</p>
</dd>
<dt>remove-path</dt><dd><p>Removes path information from the URL.</p>
</dd>
<dt>remove-all-params</dt><dd><p>Removes query parameters from the URL.</p>
</dd>
<dt>capture-prefix-uri</dt><dd><p>This is usually used in concert with remove-path and remove-all-params parameters. Capture-prefix-uri will let you use your own, full regular expression for non-trivial cases.</p>
</dd>
</dl>
</div>
<div class="section" id="examples-of-cacheurl-to-cachekey-replacements">
<h2>Examples of Cacheurl to Cachekey Replacements<a class="headerlink" href="#examples-of-cacheurl-to-cachekey-replacements" title="Permalink to this headline">¶</a></h2>
<div class="section" id="static-prefix-example">
<h3>Static Prefix Example<a class="headerlink" href="#static-prefix-example" title="Permalink to this headline">¶</a></h3>
<p>Original regex value:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>http://test.net/(.*) http://test-cdn.net/$1
</pre></div>
</div>
<table class="docutils align-default" id="id3">
<caption><span class="caption-text">Cachekey Parameters</span><a class="headerlink" href="#id3" title="Permalink to this table">¶</a></caption>
<colgroup>
<col style="width: 23%" />
<col style="width: 26%" />
<col style="width: 51%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Parameter</p></th>
<th class="head"><p>File</p></th>
<th class="head"><p>Value</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>static-prefix</p></td>
<td><p>cachekey.config</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">http://test-cdn.net/</span></code></p></td>
</tr>
<tr class="row-odd"><td><p>separator</p></td>
<td><p>cachekey.config</p></td>
<td><p>(empty space)</p></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="removing-query-parameters-and-path-information">
<h3>Removing Query Parameters and Path Information<a class="headerlink" href="#removing-query-parameters-and-path-information" title="Permalink to this headline">¶</a></h3>
<p>Original regex value:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>http://([^?]+)(?:?|$) http://test-cdn.net/$1
</pre></div>
</div>
<table class="docutils align-default" id="id4">
<caption><span class="caption-text">Cachekey Parameters</span><a class="headerlink" href="#id4" title="Permalink to this table">¶</a></caption>
<colgroup>
<col style="width: 25%" />
<col style="width: 18%" />
<col style="width: 57%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Parameter</p></th>
<th class="head"><p>File</p></th>
<th class="head"><p>Value</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>remove-path</p></td>
<td><p>cachekey.config</p></td>
<td><p>true</p></td>
</tr>
<tr class="row-odd"><td><p>remove-all-params</p></td>
<td><p>cachekey.config</p></td>
<td><p>true</p></td>
</tr>
<tr class="row-even"><td><p>separator</p></td>
<td><p>cachekey.config</p></td>
<td><p>(empty space)</p></td>
</tr>
<tr class="row-odd"><td><p>capture-prefix-uri</p></td>
<td><p>cachekey.config</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">/https?:\/\/([^?]*)/http:\/\/test-cdn.net\/$1/</span></code></p></td>
</tr>
</tbody>
</table>
<p>Also note the <code class="docutils literal notranslate"><span class="pre">s?</span></code> used here so that both HTTP and HTTPS requests will end up with the same key value</p>
</div>
<div class="section" id="removing-query-parameters-with-a-static-prefix">
<h3>Removing Query Parameters with a Static Prefix<a class="headerlink" href="#removing-query-parameters-with-a-static-prefix" title="Permalink to this headline">¶</a></h3>
<p>Original regex value:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>http://test.net/([^?]+)(?:\?|$) http://test-cdn.net/$1
</pre></div>
</div>
<table class="docutils align-default" id="id5">
<caption><span class="caption-text">Cachekey Parameters</span><a class="headerlink" href="#id5" title="Permalink to this table">¶</a></caption>
<colgroup>
<col style="width: 28%" />
<col style="width: 25%" />
<col style="width: 48%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Parameter</p></th>
<th class="head"><p>File</p></th>
<th class="head"><p>Value</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>static-prefix</p></td>
<td><p>cachekey.config</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">http://test-cdn.net/</span></code></p></td>
</tr>
<tr class="row-odd"><td><p>separator</p></td>
<td><p>cachekey.config</p></td>
<td><p>(empty space)</p></td>
</tr>
<tr class="row-even"><td><p>remove-all-params</p></td>
<td><p>cachekey.config</p></td>
<td><p>true</p></td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Further documentation on the Cachekey Plugin can be found at <a class="reference external" href="https://docs.trafficserver.apache.org/en/latest/admin-guide/plugins/cachekey.en.html">the Apache Traffic Server Documentation</a>.</p>
</div>
</div>
</div>
<div class="section" id="apache-traffic-server-7-x-logging">
<h2>Apache Traffic Server 7.x (Logging)<a class="headerlink" href="#apache-traffic-server-7-x-logging" title="Permalink to this headline">¶</a></h2>
<p>Traffic Server has changed the logging format as of version 7.0. Previously, this was <code class="docutils literal notranslate"><span class="pre">logs_xml.config</span></code> - an XML file - and now it is <code class="docutils literal notranslate"><span class="pre">logging.config</span></code> - a Lua file. Traffic Control compensates for this
automatically depending upon the filename used for the logging parameters. The same parameters will work this new file, <code class="docutils literal notranslate"><span class="pre">LogFormat.Format</span></code>, <code class="docutils literal notranslate"><span class="pre">LogFormat.Name</span></code>, <code class="docutils literal notranslate"><span class="pre">LogObject.Format</span></code> etc.</p>
</div>
<div class="section" id="traffic-ops-profile-modifications">
<h2>Traffic Ops Profile Modifications<a class="headerlink" href="#traffic-ops-profile-modifications" title="Permalink to this headline">¶</a></h2>
<p>When upgrading to ATS 7.x, the Traffic Ops EDGE and MID cache profiles must be modified to provide new configuration values. Traffic Server’s recommended parameter changes can be found <a class="reference external" href="https://cwiki.apache.org/confluence/display/TS/Upgrading+to+v7.0">on their wiki</a>.</p>
<p>Most users of Traffic Control have enough profiles to make the task of making these modifications manually a tedious and time-consuming process. A new utility <code class="docutils literal notranslate"><span class="pre">traffic_ops/install/bin/convert_profile/convert_profile</span></code> is provided to automatically convert an ATS 6.x profile into an ATS 7.x profile. This utility can be reused in the future for converting ATS 7.x profiles into ATS 8.x profiles.</p>
<div class="section" id="usage-example">
<h3>Usage Example<a class="headerlink" href="#usage-example" title="Permalink to this headline">¶</a></h3>
<ol class="arabic simple">
<li><p>Use Traffic Portal GUI to export profile to JSON (‘Configure’ -&gt; ‘Profiles’ -&gt; Desired profile -&gt; ‘More’ -&gt; ‘Export Profile’)</p></li>
<li><p>Modify the Traffic Server version numbers to match your current Traffic Server 6.x RPM version and planned Traffic Server 7.x RPM version</p></li>
<li><p>Run <code class="docutils literal notranslate"><span class="pre">convert_profile</span> <span class="pre">-input_profile</span> <span class="pre">&lt;exported_file&gt;</span> <span class="pre">-rules</span> <span class="pre">convert622to713.json</span> <span class="pre">-out</span> <span class="pre">&lt;new_profile_name&gt;</span></code></p></li>
<li><p>Review output messages and make manual updates as needed. If you have modified a default value which the script also wants to change, it will prompt you to make the update manually. You may either do this directly in the JSON file or through the Traffic Portal GUI after import.</p></li>
<li><p>Use Traffic Portal GUI to import the newly created profile (‘Configure’ -&gt; ‘Profiles’ -&gt; ‘More’ -&gt; ‘Import Profile’)</p></li>
</ol>
<dl class="footnote brackets">
<dt class="label" id="id2"><span class="brackets"><a class="fn-backref" href="#id1">1</a></span></dt>
<dd><p>Another name previously used for HTTP Delivery Services was <code class="docutils literal notranslate"><span class="pre">ccr</span></code></p>
</dd>
</dl>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="configuration.html" class="btn btn-neutral float-right" title="Traffic Ops - Configuring" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="migration_from_10_to_20.html" class="btn btn-neutral float-left" title="Traffic Ops - Migrating from 1.x to 2.x" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Apache Traffic Control

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>