


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Configure Regional Geo-blocking (RGB) &mdash; Traffic Control 3.1.0 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Configure Anonymous Blocking" href="anonymous_blocking.html" />
    <link rel="prev" title="Configure Federations" href="federations.html" />
    <link href="../../_static/theme_overrides.css" rel="stylesheet" type="text/css"/>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> Traffic Control
          

          
            
            <img src="../../_static/ATC-SVG-FULL-WHITE.svg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../basics/index.html">CDN Basics</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../overview/index.html">Traffic Control Overview</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Administrator’s Guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../traffic_ops/installation.html">Traffic Ops - Installing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../traffic_ops/migration_from_10_to_20.html">Traffic Ops - Migrating from 1.x to 2.x</a></li>
<li class="toctree-l2"><a class="reference internal" href="../traffic_ops/migration_from_20_to_22.html">Traffic Ops - Migrating from 2.0 to 2.2</a></li>
<li class="toctree-l2"><a class="reference internal" href="../traffic_ops/configuration.html">Traffic Ops - Configuring</a></li>
<li class="toctree-l2"><a class="reference internal" href="../traffic_ops/using.html">Traffic Ops - Using</a></li>
<li class="toctree-l2"><a class="reference internal" href="../traffic_ops/extensions.html">Managing Traffic Ops Extensions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../traffic_portal/installation.html">Traffic Portal Administration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../traffic_portal/usingtrafficportal.html">Traffic Portal - Using</a></li>
<li class="toctree-l2"><a class="reference internal" href="../traffic_portal/default_profiles.html">Default Profiles</a></li>
<li class="toctree-l2"><a class="reference internal" href="../traffic_monitor.html">Traffic Monitor Administration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../traffic_router.html">Traffic Router Administration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../traffic_router/migrationto2-3.html">Traffic Router - Migrating to 3.0</a></li>
<li class="toctree-l2"><a class="reference internal" href="../traffic_stats.html">Traffic Stats Administration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../traffic_server.html">Traffic Server Administration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../traffic_vault.html">Traffic Vault Administration</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Quick How To Guides</a><ul class="current">
<li class="toctree-l3 current"><a class="reference internal" href="index.html#traffic-ops">Traffic Ops</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="multi_site.html">Configure Multi-Site Origin</a></li>
<li class="toctree-l4"><a class="reference internal" href="federations.html">Configure Federations</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">Configure Regional Geo-blocking (RGB)</a></li>
<li class="toctree-l4"><a class="reference internal" href="anonymous_blocking.html">Configure Anonymous Blocking</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="index.html#traffic-portal">Traffic Portal</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../development/index.html">Developer’s Guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api/index.html">APIs</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../faq/index.html">FAQ</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../glossary.html">Glossary</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Traffic Control</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Administrator’s Guide</a> &raquo;</li>
        
          <li><a href="index.html">Quick How To Guides</a> &raquo;</li>
        
      <li>Configure Regional Geo-blocking (RGB)</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/admin/quick_howto/regionalgeo.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="configure-regional-geo-blocking-rgb">
<span id="regionalgeo-qht"></span><h1>Configure Regional Geo-blocking (RGB)<a class="headerlink" href="#configure-regional-geo-blocking-rgb" title="Permalink to this headline">¶</a></h1>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>RGB is only supported for HTTP delivery services.</p>
</div>
<ol class="arabic">
<li><p>Prepare an RGB configuration file. RGB uses a configuration file in JSON format to define regional geographic blocking rules for Delivery Services. The file needs to be put on an HTTP server accessible to Traffic Router.</p>
<blockquote>
<div><div class="literal-block-wrapper docutils container" id="id1">
<div class="code-block-caption"><span class="caption-text">Example Configuration File</span><a class="headerlink" href="#id1" title="Permalink to this code">¶</a></div>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="nt">&quot;deliveryServices&quot;</span><span class="p">:</span>
        <span class="p">[</span>
                <span class="p">{</span>
                        <span class="nt">&quot;deliveryServiceId&quot;</span><span class="p">:</span> <span class="s2">&quot;hls-live&quot;</span><span class="p">,</span>
                        <span class="nt">&quot;urlRegex&quot;</span><span class="p">:</span> <span class="s2">&quot;.*live4\\.m3u8&quot;</span><span class="p">,</span>
                        <span class="nt">&quot;geoLocation&quot;</span><span class="p">:</span> <span class="p">{</span><span class="nt">&quot;includePostalCode&quot;</span><span class="p">:[</span><span class="s2">&quot;N0H&quot;</span><span class="p">,</span> <span class="s2">&quot;L9V&quot;</span><span class="p">,</span> <span class="s2">&quot;L9W&quot;</span><span class="p">]},</span>
                        <span class="nt">&quot;redirectUrl&quot;</span><span class="p">:</span> <span class="s2">&quot;http://third-party.com/blacked_out.html&quot;</span>
                <span class="p">},</span>
                <span class="p">{</span>
                        <span class="nt">&quot;deliveryServiceId&quot;</span><span class="p">:</span> <span class="s2">&quot;hls-live&quot;</span><span class="p">,</span>
                        <span class="nt">&quot;urlRegex&quot;</span><span class="p">:</span> <span class="s2">&quot;.*live5\\.m3u8&quot;</span><span class="p">,</span>
                        <span class="nt">&quot;ipWhiteList&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;185.68.71.9/22&quot;</span><span class="p">,</span><span class="s2">&quot;142.232.0.79/24&quot;</span><span class="p">],</span>
                        <span class="nt">&quot;geoLocation&quot;</span><span class="p">:</span> <span class="p">{</span><span class="nt">&quot;excludePostalCode&quot;</span><span class="p">:[</span><span class="s2">&quot;N0H&quot;</span><span class="p">,</span> <span class="s2">&quot;L9V&quot;</span><span class="p">]},</span>
                        <span class="nt">&quot;redirectUrl&quot;</span><span class="p">:</span> <span class="s2">&quot;/live5_low_bitrate.m3u8&quot;</span>
                <span class="p">}</span>
        <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">deliveryServiceId</span></code></dt><dd><p>Should be equal to the <code class="docutils literal notranslate"><span class="pre">ID</span></code> or <code class="docutils literal notranslate"><span class="pre">xml_id</span></code> field of the intended Delivery Service as configured in Traffic Portal</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">urlRegex</span></code></dt><dd><p>A regular expression to be used to determine to what URLs the rule shall apply; a URL that matches it is subject to the rule</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">geoLocation</span></code></dt><dd><p>An object that currently supports only the keys <code class="docutils literal notranslate"><span class="pre">includePostalCode</span></code> and <code class="docutils literal notranslate"><span class="pre">excludePostalCode</span></code> (mutually exclusive). When the <code class="docutils literal notranslate"><span class="pre">includePostalCode</span></code> key is used, only the clients whose Forward Sortation Areas (FSA)s - the first three postal characters of Canadian postal codes - are in the <code class="docutils literal notranslate"><span class="pre">includePostalCode</span></code> list are able to view the content at URLs matched by the <code class="docutils literal notranslate"><span class="pre">urlRegex</span></code>. When <code class="docutils literal notranslate"><span class="pre">excludePostalCode</span></code> is used, any client whose FSA is not in the <code class="docutils literal notranslate"><span class="pre">excludePostalCode</span></code> list will be allowed to view the content</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">redirectUrl</span></code></dt><dd><p>The URL that will be returned to the blocked clients. Without a domain name in the URL, the URL will still be served in the same Delivery Service. Thus Traffic Router will redirect the client to a chosen cache server assigned to the Delivery Service. If the URL includes a domain name, Traffic Router simply redirects the client to the defined URL. In the later case, the redirect URL must not match the <code class="docutils literal notranslate"><span class="pre">urlRegex</span></code> value, or an infinite loop of  HTTP <code class="docutils literal notranslate"><span class="pre">302</span> <span class="pre">Found</span></code> responses will occur at the Traffic Router</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">ipWhiteList</span></code></dt><dd><p>An optional element that is an array of CIDR (Classless Inter-Domain Routing) blocks indicating the IPv4 subnets that are allowed by the rule. If this list exists and the value is not empty, client IP will be matched against the CIDR list, bypassing the value of <code class="docutils literal notranslate"><span class="pre">geoLocation</span></code>. If there is no match in the white list, Traffic Router defers to the value of <code class="docutils literal notranslate"><span class="pre">geoLocation</span></code> to determine if content ought to be blocked.</p>
</dd>
</dl>
</div></blockquote>
</li>
<li><p>Add RGB parameters in Traffic Portal to the Delivery Service’s Traffic Router(s)’s profile(s). The <code class="docutils literal notranslate"><span class="pre">configFile</span></code> field should be set to <code class="docutils literal notranslate"><span class="pre">CRConfig.json</span></code>, and the following two parameter name/values need to be specified:</p>
<blockquote>
<div><dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">regional_geoblocking.polling.url</span></code></dt><dd><p>The URL of the RGB configuration file. Traffic Router will fetch the file from this URL using an HTTP <code class="docutils literal notranslate"><span class="pre">GET</span></code> request.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">regional_geoblocking.polling.interval</span></code></dt><dd><p>The interval on which Traffic Router polls the RGB configuration file.</p>
</dd>
</dl>
<div class="figure align-center">
<a class="reference internal image-reference" href="../../_images/014.png"><img alt="../../_images/014.png" src="../../_images/014.png" style="width: 1234.0px; height: 430.0px;" /></a>
</div>
</div></blockquote>
</li>
<li><p>Enable RGB for a delivery service</p>
<blockquote>
<div><div class="figure align-center">
<a class="reference internal image-reference" href="../../_images/024.png"><img alt="../../_images/024.png" src="../../_images/024.png" style="width: 1046.0px; height: 1054.0px;" /></a>
</div>
</div></blockquote>
</li>
<li><p>Go to Tools-&gt;Snapshot CRConfig, perform “Diff CRConfig” and click “Write CRConfig”.</p>
<blockquote>
<div><div class="figure align-center">
<a class="reference internal image-reference" href="../../_images/03.png"><img alt="../../_images/03.png" src="../../_images/03.png" style="width: 464.79999999999995px; height: 128.79999999999998px;" /></a>
</div>
</div></blockquote>
</li>
</ol>
<div class="section" id="traffic-router-access-log">
<h2>Traffic Router Access Log<a class="headerlink" href="#traffic-router-access-log" title="Permalink to this headline">¶</a></h2>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="../traffic_router.html#tr-logs"><span class="std std-ref">Troubleshooting and Log Files</span></a></p>
</div>
<p>RGB extends the <code class="docutils literal notranslate"><span class="pre">rtype</span></code> field and adds a new field <code class="docutils literal notranslate"><span class="pre">rgb</span></code> in Traffic Router access.log to help to monitor this feature. A value of <code class="docutils literal notranslate"><span class="pre">RGALT</span></code> in the <code class="docutils literal notranslate"><span class="pre">rtype</span></code> field indicates that a request is redirected to an alternate URL by RGB; a value of <code class="docutils literal notranslate"><span class="pre">RGDENY</span></code> indicates that a request is denied by RGB because there is no matching rule in the RGB configuration file for this request. When RGB is enabled, the <code class="docutils literal notranslate"><span class="pre">RGB</span></code> field will be non-empty with following format:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">FSA</span><span class="p">}:{</span><span class="n">allowed</span><span class="o">/</span><span class="n">disallowed</span><span class="p">}:{</span><span class="n">include</span><span class="o">/</span><span class="n">exclude</span> <span class="n">postal</span><span class="p">}:{</span><span class="n">fallback</span> <span class="n">config</span><span class="p">}:{</span><span class="n">allowed</span> <span class="n">by</span> <span class="n">whitelist</span><span class="p">}</span>
</pre></div>
</div>
<dl class="simple">
<dt>FSA</dt><dd><p>FSA part of the client’s postal code, which is retrieved from a geographic location database. If this field is empty, a dash (“-“) is filled in.</p>
</dd>
<dt>allowed/disallowed</dt><dd><p>This flag shows if a request was allowed or disallowed by RGB (1 for yes, and 0 for no).</p>
</dd>
<dt>include/exclude postal</dt><dd><p>This shows that when a rule in JSON is matched for a request, it’s value is “I” if the rule matched because of an <code class="docutils literal notranslate"><span class="pre">includePostalCode</span></code> rule, “X” if the rule matched because of an <code class="docutils literal notranslate"><span class="pre">excludePostalCode</span></code> rule, or “-” if no rule matched.</p>
</dd>
<dt>fallback config</dt><dd><p>When Traffic Router fails to parse an RGB configuration file as JSON, Traffic Router will handle requests with latest valid configuration that it had, but will set the <code class="docutils literal notranslate"><span class="pre">fallback</span> <span class="pre">config</span></code> flag to 1. If no fall-back occurred, then the flag is set to 0.</p>
</dd>
<dt>allowed by whitelist</dt><dd><p>If a request is allowed by a <code class="docutils literal notranslate"><span class="pre">whitelist</span></code> field in the configuration, this flag is set to 1; for all other cases, it is 0.</p>
</dd>
</dl>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">1446442214.685</span> <span class="n">qtype</span><span class="o">=</span><span class="n">HTTP</span> <span class="n">chi</span><span class="o">=</span><span class="mf">129.100</span><span class="o">.</span><span class="mf">254.79</span> <span class="n">url</span><span class="o">=</span><span class="s2">&quot;http://foo.geo2.cdn.com/live5.m3u8&quot;</span> <span class="n">cqhm</span><span class="o">=</span><span class="n">GET</span> <span class="n">cqhv</span><span class="o">=</span><span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span> <span class="n">rtype</span><span class="o">=</span><span class="n">GEO</span> <span class="n">rloc</span><span class="o">=</span><span class="s2">&quot;-&quot;</span> <span class="n">rdtl</span><span class="o">=-</span> <span class="n">rerr</span><span class="o">=</span><span class="s2">&quot;-&quot;</span> <span class="n">rgb</span><span class="o">=</span><span class="s2">&quot;N6G:1:X:0:0&quot;</span> <span class="n">pssc</span><span class="o">=</span><span class="mi">302</span> <span class="n">ttms</span><span class="o">=</span><span class="mi">3</span> <span class="n">rurl</span><span class="o">=</span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">cent6</span><span class="o">-</span><span class="mf">44.</span><span class="n">geo2</span><span class="o">.</span><span class="n">cdn</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">live5</span><span class="o">.</span><span class="n">m3u8</span> <span class="n">rh</span><span class="o">=</span><span class="s2">&quot;-&quot;</span>

<span class="mf">1446442219.181</span> <span class="n">qtype</span><span class="o">=</span><span class="n">HTTP</span> <span class="n">chi</span><span class="o">=</span><span class="mf">184.68</span><span class="o">.</span><span class="mf">71.9</span> <span class="n">url</span><span class="o">=</span><span class="s2">&quot;http://foo.geo2.cdn.com/live5.m3u8&quot;</span> <span class="n">cqhm</span><span class="o">=</span><span class="n">GET</span> <span class="n">cqhv</span><span class="o">=</span><span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span> <span class="n">rtype</span><span class="o">=</span><span class="n">RGALT</span> <span class="n">rloc</span><span class="o">=</span><span class="s2">&quot;-&quot;</span> <span class="n">rdtl</span><span class="o">=-</span> <span class="n">rerr</span><span class="o">=</span><span class="s2">&quot;-&quot;</span> <span class="n">rgb</span><span class="o">=</span><span class="s2">&quot;-:0:X:0:0&quot;</span> <span class="n">pssc</span><span class="o">=</span><span class="mi">302</span> <span class="n">ttms</span><span class="o">=</span><span class="mi">3</span> <span class="n">rurl</span><span class="o">=</span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">cent6</span><span class="o">-</span><span class="mf">44.</span><span class="n">geo2</span><span class="o">.</span><span class="n">cdn</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">low_bitrate</span><span class="o">.</span><span class="n">m3u8</span> <span class="n">rh</span><span class="o">=</span><span class="s2">&quot;-&quot;</span>

<span class="mf">1446445521.677</span> <span class="n">qtype</span><span class="o">=</span><span class="n">HTTP</span> <span class="n">chi</span><span class="o">=</span><span class="mf">24.114</span><span class="o">.</span><span class="mf">29.79</span> <span class="n">url</span><span class="o">=</span><span class="s2">&quot;http://foo.geo2.cdn.com/live51.m3u8&quot;</span> <span class="n">cqhm</span><span class="o">=</span><span class="n">GET</span> <span class="n">cqhv</span><span class="o">=</span><span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span> <span class="n">rtype</span><span class="o">=</span><span class="n">RGDENY</span> <span class="n">rloc</span><span class="o">=</span><span class="s2">&quot;-&quot;</span> <span class="n">rdtl</span><span class="o">=-</span> <span class="n">rerr</span><span class="o">=</span><span class="s2">&quot;-&quot;</span> <span class="n">rgb</span><span class="o">=</span><span class="s2">&quot;L4S:0:-:0:0&quot;</span> <span class="n">pssc</span><span class="o">=</span><span class="mi">520</span> <span class="n">ttms</span><span class="o">=</span><span class="mi">3</span> <span class="n">rurl</span><span class="o">=</span><span class="s2">&quot;-&quot;</span> <span class="n">rh</span><span class="o">=</span><span class="s2">&quot;-&quot;</span>
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="anonymous_blocking.html" class="btn btn-neutral float-right" title="Configure Anonymous Blocking" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="federations.html" class="btn btn-neutral float-left" title="Configure Federations" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Apache Traffic Control

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>